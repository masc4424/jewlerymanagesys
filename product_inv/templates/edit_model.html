{% extends 'base.html' %}
{% load static %}

{% block title %}Create Model{% endblock %}

{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}
{% block content %}
<style>
    /* Add this to your CSS */
.nav-tabs .nav-link.active {
    background-color: #fff !important;
    color: #696cff !important;
    border-color: #d9dee3 #d9dee3 #fff !important;
    border-bottom: 2px solid #696cff !important;
}
.nav-tabs .nav-item .nav-link:not(.active) {
    background-color: white !important;
}

.tab-pane.active {
    display: block !important;
}

th {
    text-transform: none !important;
    font-size: 13px;
}
label.form-label {
    text-transform: none !important;
}
.zoom-controls {
  position: absolute;
   
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    display: flex;
    gap: 10px;
   

}
@media (max-width: 768px) {
  .zoom-controls {
    margin-top: 58px;
  }
}
</style>

<div class="content-wrapper">
    <div class="container-xxl flex-grow-1 container-p-y p-0">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-1">
                <a href="{% url 'product_list' jewelry_type_name %}" class="text-dark text-decoration-none">
                    <i class="bx bx-arrow-back me-2"></i>
                </a>
                Edit Model
            </h4>
        </div>
        <div class="card">
            <h5 class="card-header"></h5>
            <div class="card-body">
                <form id="updateModelForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" id="model_id" name="model_id" value="{{ model_id }}">
                    <input type="hidden" id="jewelry_type" name="jewelry_type" value="{{ jewelry_type_id }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="model_no" class="form-label">Model No</label>
                                <input type="text" class="form-control" id="model_no" name="model_no" value="{{ model.model_no }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="colors" class="form-label">Model Colors</label>
                                <select class="form-select select22" id="colors" name="colors" multiple >
                                    <option value="GJ" {% if 'GJ' in model.colors %}selected{% endif %}>Ganga Jamuna</option>
                                    <option value="Black" {% if 'Black' in model.colors %}selected{% endif %}>Black</option>
                                    <option value="White" {% if 'White' in model.colors %}selected{% endif %}>White</option>
                                    <option value="Gray" {% if 'Gray' in model.colors %}selected{% endif %}>Gray</option>
                                    <option value="Silver" {% if 'Silver' in model.colors %}selected{% endif %}>Silver</option>
                                    <option value="Gold" {% if 'Gold' in model.colors %}selected{% endif %}>Gold</option>
                                    <option value="Rose Gold" {% if 'Rose Gold' in model.colors %}selected{% endif %}>Rose Gold</option>
                                    <option value="Platinum" {% if 'Platinum' in model.colors %}selected{% endif %}>Platinum</option>
                                    <option value="Bronze" {% if 'Bronze' in model.colors %}selected{% endif %}>Bronze</option>
                                    <option value="Copper" {% if 'Copper' in model.colors %}selected{% endif %}>Copper</option>
                                    <option value="Red" {% if 'Red' in model.colors %}selected{% endif %}>Red</option>
                                    <option value="Crimson" {% if 'Crimson' in model.colors %}selected{% endif %}>Crimson</option>
                                    <option value="Maroon" {% if 'Maroon' in model.colors %}selected{% endif %}>Maroon</option>
                                    <option value="Burgundy" {% if 'Burgundy' in model.colors %}selected{% endif %}>Burgundy</option>
                                    <option value="Pink" {% if 'Pink' in model.colors %}selected{% endif %}>Pink</option>
                                    <option value="Hot Pink" {% if 'Hot Pink' in model.colors %}selected{% endif %}>Hot Pink</option>
                                    <option value="Magenta" {% if 'Magenta' in model.colors %}selected{% endif %}>Magenta</option>
                                    <option value="Salmon" {% if 'Salmon' in model.colors %}selected{% endif %}>Salmon</option>
                                    <option value="Peach" {% if 'Peach' in model.colors %}selected{% endif %}>Peach</option>
                                    <option value="Orange" {% if 'Orange' in model.colors %}selected{% endif %}>Orange</option>
                                    <option value="Amber" {% if 'Amber' in model.colors %}selected{% endif %}>Amber</option>
                                    <option value="Coral" {% if 'Coral' in model.colors %}selected{% endif %}>Coral</option>
                                    <option value="Yellow" {% if 'Yellow' in model.colors %}selected{% endif %}>Yellow</option>
                                    <option value="Mustard" {% if 'Mustard' in model.colors %}selected{% endif %}>Mustard</option>
                                    <option value="Beige" {% if 'Beige' in model.colors %}selected{% endif %}>Beige</option>
                                    <option value="Ivory" {% if 'Ivory' in model.colors %}selected{% endif %}>Ivory</option>
                                    <option value="Lime" {% if 'Lime' in model.colors %}selected{% endif %}>Lime</option>
                                    <option value="Olive" {% if 'Olive' in model.colors %}selected{% endif %}>Olive</option>
                                    <option value="Green" {% if 'Green' in model.colors %}selected{% endif %}>Green</option>
                                    <option value="Emerald" {% if 'Emerald' in model.colors %}selected{% endif %}>Emerald</option>
                                    <option value="Jade" {% if 'Jade' in model.colors %}selected{% endif %}>Jade</option>
                                    <option value="Mint" {% if 'Mint' in model.colors %}selected{% endif %}>Mint</option>
                                    <option value="Teal" {% if 'Teal' in model.colors %}selected{% endif %}>Teal</option>
                                    <option value="Turquoise" {% if 'Turquoise' in model.colors %}selected{% endif %}>Turquoise</option>
                                    <option value="Blue" {% if 'Blue' in model.colors %}selected{% endif %}>Blue</option>
                                    <option value="Sky Blue" {% if 'Sky Blue' in model.colors %}selected{% endif %}>Sky Blue</option>
                                    <option value="Azure" {% if 'Azure' in model.colors %}selected{% endif %}>Azure</option>
                                    <option value="Cyan" {% if 'Cyan' in model.colors %}selected{% endif %}>Cyan</option>
                                    <option value="Navy Blue" {% if 'Navy Blue' in model.colors %}selected{% endif %}>Navy Blue</option>
                                    <option value="Royal Blue" {% if 'Royal Blue' in model.colors %}selected{% endif %}>Royal Blue</option>
                                    <option value="Indigo" {% if 'Indigo' in model.colors %}selected{% endif %}>Indigo</option>
                                    <option value="Purple" {% if 'Purple' in model.colors %}selected{% endif %}>Purple</option>
                                    <option value="Violet" {% if 'Violet' in model.colors %}selected{% endif %}>Violet</option>
                                    <option value="Lavender" {% if 'Lavender' in model.colors %}selected{% endif %}>Lavender</option>
                                    <option value="Lilac" {% if 'Lilac' in model.colors %}selected{% endif %}>Lilac</option>
                                    <option value="Brown" {% if 'Brown' in model.colors %}selected{% endif %}>Brown</option>
                                    <option value="Chocolate" {% if 'Chocolate' in model.colors %}selected{% endif %}>Chocolate</option>
                                    <option value="Tan" {% if 'Tan' in model.colors %}selected{% endif %}>Tan</option>
                                    <option value="Mahogany" {% if 'Mahogany' in model.colors %}selected{% endif %}>Mahogany</option>
                                    <option value="Bistre" {% if 'Bistre' in model.colors %}selected{% endif %}>Bistre</option>
                                    <option value="Charcoal" {% if 'Charcoal' in model.colors %}selected{% endif %}>Charcoal</option>
                                </select>
                            </div>
                        </div>
                        <!-- Add these to your edit form HTML -->

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="clients" class="form-label">Clients</label>
                                <select class="form-select select22" id="clients" name="clients" multiple>
                                    <!-- Options will be populated via JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status" >
                                    <option value="" selected disabled>Select Status</option>
                                    <!-- Status options will be populated via JavaScript -->
                                </select>
                                <input type="hidden" id="current_status_id" value="{{ model.status.id }}">
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="length" class="form-label">Length (cm)</label>
                                <input type="number" step="0.01" class="form-control" id="length" name="length" value="{{ model.length }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="breadth" class="form-label">Breadth (cm)</label>
                                <input type="number" step="0.01" class="form-control" id="breadth" name="breadth" value="{{ model.breadth }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="weight" class="form-label">Weight (gm)</label>
                                <input type="number" step="0.01" class="form-control" id="weight" name="weight" value="{{ model.weight }}">
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="mb-3 col-lg-auto">
                                <label for="model_img" class="form-label">Model Image</label>
                                <div class="d-flex align-items-center">
                                    <input type="file" class="form-control me-3" id="model_img" name="model_img" accept="image/*">
                                </div>
                                <small class="text-muted">Leave empty to keep current image</small>
                            </div>
                        </div>
                        <div id="previewContainer" class="col-md-2 border p-1 d-flex justify-content-center align-items-center {% if not model.model_img %}d-none{% endif %}"
                                style="height: 183px; border: 2px dashed #ddd; background-color: #f8f9fa;">
                            <img id="imagePreview" src="{{ model.model_img|default:'#' }}" alt="Image Preview" class="img-fluid img-thumbnail"
                                    style="max-width: 100%; max-height: 100%; cursor: pointer;"  data-bs-toggle="modal" data-bs-target="#imageModal">
                        </div>
                    </div>

                    <!-- Image Modal -->
                    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-fullscreen">
                        <div class="modal-content position-relative">
                            <div class="px-4 pt-1 text-center">
                                <span id="modalDimensionRow">{{ model.length }} x {{ model.breadth }}cm | {{ jewelry_type_name }} | {{ model.weight }}gm</span>
                            </div>
                            
                            <div class="modal-header">
                                <h6 class="modal-title mb-2" id="modelImageModalLabel"> <span id="">{{ model.model_no }}</span></h6>
                                <div class="zoom-controls mt-5">
                                <button class="btn btn-outline-secondary btn-sm me-2" id="zoomOut">
                                    <i class="fas fa-search-minus"></i> Zoom Out
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" id="zoomIn">
                                    <i class="fas fa-search-plus"></i> Zoom In
                                </button>
                                <button class="btn btn-outline-secondary btn-sm ms-2" id="resetZoom">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                
                            </div>
                            <!-- Close Button -->

                            <div class="modal-body p-0 mt-3">
                            <div class="position-relative">
                                <img id="modalImage" src="#" alt="Large Preview" class="img-fluid w-100" style="z-index: 1;">
                            </div>
                            </div>
                            
                        </div>

                        </div>
                    </div>
                 
                    <!-- Materials Tabs Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#stones-section" role="tab">
                                        Stones Used
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#raw-material-section" role="tab">
                                        Raw Material
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content">
                                <!-- Stones Used Section -->
                                <div class="tab-pane fade show active" id="stones-section" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0">Stone Used</h5>
                                        <div id="stoneTotalContainer" class="">
                                            <div class="">
                                                <div class="card-body">
                                                    <div class="d-flex gap-5">
                                                        <div class="d-flex gap-3 justify-content-between">
                                                            <strong>Total Rate:</strong>
                                                            <span id="totalStoneRate" class="bg-label-warning px-2"><i class="bx bx-rupee fs-big"></i>0.00</span>
                                                        </div>
                                                        <div class="d-flex gap-2 justify-content-between">
                                                            <strong>Total Weight:</strong>
                                                            <span id="totalStoneWeight" class="bg-label-warning px-2">0.00 gm</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-primary" id="addStoneButton">Add Stone Used</button>
                                    </div>
                                    <div id="stonesContainer">
                                        <!-- Stone forms will be added here dynamically -->
                                    </div>
                                    <div id="savedStonesContainer" class="mt-3">
                                        <h6>Stones Added:</h6>
                                        <table class="table table-bordered" id="savedStonesTable">
                                            <thead>
                                                <tr>
                                                    <th>Stone Name</th>
                                                    <th>Type Name</th>
                                                    <th>Weight (gm)</th>
                                                    <th>Dimensions (LxB)(cm)</th>
                                                    <th class="px-2">Rate (<i class="bx bx-rupee fs-big"></i>)</th>
                                                    <th>Count</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Saved stones will appear here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Raw Material Section -->
                                <div class="tab-pane fade" id="raw-material-section" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0">Raw Material</h5>
                                        <div id="rawMaterialTotalContainer" class="">
                                            <div class="">
                                                <div class="d-flex gap-5">
                                                    <div class="">
                                                        <div class="d-flex justify-content-between gap-2">
                                                            <strong>Total Material Weight:</strong>
                                                            <span id="totalRawMaterialWeight" class="bg-label-warning px-1">0.00 gm</span>
                                                        </div>
                                                    </div>
                                                    <div class="">
                                                        <div class="d-flex justify-content-between gap-2">
                                                            <strong>Total Material Value:</strong>
                                                            <span id="totalRawMaterialValue" class="bg-label-warning px-1"><i class="bx bx-rupee fs-big"></i>0.00</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-primary" id="addRawMaterialButton">Add Raw Material</button>
                                    </div>
                                    <div id="rawMaterialsContainer">
                                        <!-- Raw material forms will be added here dynamically -->
                                    </div>
                                    <div id="savedRawMaterialsContainer" class="mt-3">
                                        <h6>Raw Materials Added:</h6>
                                        <table class="table table-bordered" id="savedRawMaterialsTable">
                                            <thead>
                                                <tr>
                                                    <th>Material</th>
                                                    <th>Weight (gm)</th>
                                                    <th>Rate (<i class="bx bx-rupee fs-big"></i>)</th>
                                                    <th>Total Value</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Saved raw materials will appear here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-end">
                        <a href="{% url 'product_list' jewelry_type_name %}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Update Model</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Stone Form Template (Hidden) -->
<template id="stoneFormTemplate">
    <div class="stone-form-container mb-3 p-3 border rounded">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Stone Name</label>
                    <select class="form-control stone-name-select">
                        <option value="">Select Stone</option>
                        <!-- Options will be populated from the database -->
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Type Name</label>
                    <select class="form-control stone-type-select">
                        <option value="">Select Type</option>
                        <!-- Options will be populated based on selected stone -->
                    </select>
                </div>
            </div>
        </div>
        <div class="text-end">
            <button type="button" class="btn bg-label-danger cancel-stone-btn me-2">Cancel</button>
            <button type="button" class="btn btn-primary save-stone-btn">Save</button>
        </div>
    </div>
</template>

<!-- Raw Material Form Template (Hidden) -->
<template id="rawMaterialFormTemplate">
    <div class="raw-material-form-container mb-3 p-3 border rounded">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Material</label>
                    <select class="form-control raw-material-select">
                        <option value="">Select Material</option>
                        <!-- Options will be populated from the database -->
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Weight (gm)</label>
                    <div class="input-group">
                        <input type="number" step="0.01" class="form-control raw-material-weight">
                        <div class="input-group-text">
                            <button type="button" class="btn btn-sm btn-primary get-rate-button">Get Rate</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" id="rateContainer" style="display: none;">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Current Rate</label>
                    <input type="text" class="form-control raw-material-rate" readonly>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Total Value</label>
                    <input type="text" class="form-control raw-material-total-value" readonly>
                </div>
            </div>
        </div>
        <div class="text-end">
            <button type="button" class="btn bg-label-danger cancel-raw-material-btn me-2">Cancel</button>
            <button type="button" class="btn btn-primary save-raw-material-btn">Save</button>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
// Initialize zoom functionality when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize zoom level
    window.currentZoomLevel = 1;
    const zoomStep = 0.1;
    
    // Get elements
    const img = document.getElementById('modalImage');
    const zoomIn = document.getElementById('zoomIn');
    const zoomOut = document.getElementById('zoomOut');
    const resetZoom = document.getElementById('resetZoom');
    const modal = document.getElementById('imageModal');

    // Keep modal open - prevent it from closing unexpectedly
    if (modal) {
        // Prevent default behavior for keyboard events on modal
        modal.addEventListener('keydown', function(e) {
            e.stopPropagation();
        });
        
        // Make sure the modal doesn't close on backdrop click
        // This is for Bootstrap 5
        if (typeof bootstrap !== 'undefined') {
            modal.addEventListener('show.bs.modal', function() {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance._config.backdrop = 'static';
                    modalInstance._config.keyboard = false;
                }
            });
        }
    }

    // Zoom in function
    zoomIn.addEventListener('click', function(e) {
        e.preventDefault(); // Prevent any default behavior
        e.stopPropagation(); // Stop event from bubbling
        
        // Remove the maximum zoom check
        window.currentZoomLevel += zoomStep;
        applyZoom();
    });

    // Zoom out function
    zoomOut.addEventListener('click', function(e) {
        e.preventDefault(); // Prevent any default behavior
        e.stopPropagation(); // Stop event from bubbling
        
        // Remove the minimum zoom check
        window.currentZoomLevel -= zoomStep;
        applyZoom();
    });

    // Reset zoom function
    resetZoom.addEventListener('click', function(e) {
        e.preventDefault(); // Prevent any default behavior
        e.stopPropagation(); // Stop event from bubbling
        
        window.currentZoomLevel = 1;
        applyZoom();
    });

    // Mouse wheel zoom - with additional event stopping
    const modalBody = document.querySelector('#imageModal .modal-body');
    modalBody.addEventListener('wheel', function(e) {
        // Stop all default behavior and propagation
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        if (e.deltaY < 0) {
            // Zoom in - no maximum limit
            window.currentZoomLevel += zoomStep;
            applyZoom();
        } else if (e.deltaY > 0) {
            // Zoom out - no minimum limit
            window.currentZoomLevel -= zoomStep;
            applyZoom();
        }
        
        // Return false to be extra safe
        return false;
    }, { passive: false });

    // Add event listeners to form fields to update modal info in real-time
    document.getElementById('length').addEventListener('input', updateModalInfo);
    document.getElementById('breadth').addEventListener('input', updateModalInfo);
    document.getElementById('weight').addEventListener('input', updateModalInfo);
    document.getElementById('jewelry_type').addEventListener('change', updateModalInfo);
    document.getElementById('model_no').addEventListener('input', updateModalInfo);
});

// Apply zoom level to image
function applyZoom() {
    const img = document.getElementById('modalImage');
    if (img) {
        img.style.transition = 'transform 0.2s ease';
        img.style.transform = `scale(${window.currentZoomLevel})`;
        
        // Log zoom level to help with debugging
        console.log('Current zoom level:', window.currentZoomLevel);
        
        // Prevent modal from closing by stopping any potential events
        // that might be triggered by extreme zoom levels
        event.stopPropagation();
    }
}

// Preview image function
function previewImage(input) {
    const imagePreview = document.getElementById('imagePreview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
        };
        
        reader.readAsDataURL(input.files[0]);
    }
}

// Update modal info when form fields change
function updateModalInfo() {
    const length = document.getElementById('length').value || '0';
    const breadth = document.getElementById('breadth').value || '0';
    const weight = document.getElementById('weight').value || '0';
    const jewelryType = document.getElementById('jewelry_type').options[document.getElementById('jewelry_type').selectedIndex].text || 'Unknown';
    const modelNo = document.getElementById('model_no').value || 'Unknown';

    // Format values
    const formattedLength = parseFloat(length) % 1 === 0 ? parseFloat(length).toFixed(0) : parseFloat(length).toFixed(2);
    const formattedBreadth = parseFloat(breadth) % 1 === 0 ? parseFloat(breadth).toFixed(0) : parseFloat(breadth).toFixed(2);
    const formattedWeight = parseFloat(weight) % 1 === 0 ? parseFloat(weight).toFixed(0) : parseFloat(weight).toFixed(2);

    // Update modal elements
    document.getElementById('modalDimensionRow').textContent = `${formattedLength} × ${formattedBreadth}cm | ${jewelryType} | ${formattedWeight}gm`;
    document.getElementById('modelNoDisplay').textContent = modelNo;
}

// Open image modal function
function openImageModal() {
    const imagePreview = document.getElementById('imagePreview');
    const modalImage = document.getElementById('modalImage');
    const modal = document.getElementById('imageModal');
    
    // Set the modal image source to the preview image source
    modalImage.src = imagePreview.src;
    
    // Update modal info with current form values
    updateModalInfo();
    
    // Reset zoom when opening modal
    window.currentZoomLevel = 1;
    applyZoom();
    
    // Configure modal options to prevent closing
    if (typeof bootstrap !== 'undefined') {
        const modalOptions = {
            backdrop: 'static',  // Prevents closing when clicking outside
            keyboard: false      // Prevents closing with keyboard
        };
        
        // Open the modal using Bootstrap with the configured options
        const bsModal = new bootstrap.Modal(modal, modalOptions);
        bsModal.show();
        
        // Add click event listener to the close button specifically to control closing
        const closeButtons = modal.querySelectorAll('[data-bs-dismiss="modal"]');
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                bsModal.hide();
            });
        });
    } else {
        // Fallback if bootstrap is not defined
        modal.style.display = 'block';
    }
}

// Alternative function matching your original naming convention
function openModelImageModal(imageSrc, modelNo, length, breadth, weight, jewelryTypeName) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modelNoDisplay = document.getElementById('modelNoDisplay');
    const dimensionRow = document.getElementById('modalDimensionRow');
    
    // Format values
    const formattedLength = length % 1 === 0 ? length.toFixed(0) : length.toFixed(2);
    const formattedBreadth = breadth % 1 === 0 ? breadth.toFixed(0) : breadth.toFixed(2);
    const formattedWeight = weight % 1 === 0 ? weight.toFixed(0) : weight.toFixed(2);
    
    // Set image and model number
    modalImage.src = imageSrc;
    modelNoDisplay.textContent = modelNo;
    
    // Set the Dimensions | Jewelry Type | Weight row
    dimensionRow.textContent = `${formattedLength} × ${formattedBreadth}cm | ${jewelryTypeName} | ${formattedWeight}gm`;
    
    // Reset zoom when opening modal
    window.currentZoomLevel = 1;
    applyZoom();
    
    // Configure modal options to prevent closing
    if (typeof bootstrap !== 'undefined') {
        const modalOptions = {
            backdrop: 'static',  // Prevents closing when clicking outside
            keyboard: false      // Prevents closing with keyboard
        };
        
        // Open the modal using Bootstrap with the configured options
        const bsModal = new bootstrap.Modal(modal, modalOptions);
        bsModal.show();
        
        // Add click event listener to the close button specifically to control closing
        const closeButtons = modal.querySelectorAll('[data-bs-dismiss="modal"]');
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                bsModal.hide();
            });
        });
    } else {
        // Fallback if bootstrap is not defined
        modal.style.display = 'block';
    }
}
</script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{% static 'js/model_edit.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}